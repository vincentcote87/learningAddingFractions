<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <meta charset="UTF-8">
    <title>Fractions</title>
    <style>
        .divisionBox {
            outline: solid #000000 3px;
            fill: #ffffff;
            opacity: 1.0;
            z-index: -1;
        }

        .filledNum {
            z-index: 99;
        }

        .fractionInput {
            max-width: 30px;
        }
        .fractionText {
            font: 25px serif;
            fill: black;
        }
        .lOpperandDivisonBoxFractionText {
            fill: red;
        }
        .rOpperandDivisonBoxFractionText {
            fill: red;
        }
        hr {
            max-width: 40px;
            height: 3px;
            background-color: #000000;
        }
        input {
            text-align: center;
        }
    </style>
</head>
<body>
<div style="margin: 50px;">
    <div style="float: left; margin: 40px 20px 20px 16px;">
        <div>
            <input type="text" class="fractionInput" id="lOppNumerator">
        </div>
        <div>
            <hr align="left">
        </div>
        <div>
            <input type="text" class="fractionInput" id="lOppDenominator">
        </div>
        <div style="margin-top: 80px">
            <input type="text" class="fractionInput" id="rOppNumerator">
        </div>
        <div>
            <hr align="left">
        </div>
        <div>
            <input type="text" class="fractionInput" id="rOppDenominator">
        </div>
    </div>

    <svg width="850" height="420" id="mainCanvas" style="float: left">
      <rect height="100" width="400" x="20" y="20" class="divisionBox"></rect>
      <rect height="0" width="0" x="20" y="300" class="divisionBox" id="answerBox"></rect>
        <rect height="100" width="400" x="20" y="20" class="divisionBox" id="lOpperandDivisonBox"></rect>
        <rect height="100" width="0" x="20" y="20" class="filledNum" id="lOpperandDivisonBoxFilled"></rect>
        <rect height="100" width="0" x="20" y="20" class="filledNum" id="lOpperandDivisonBoxAnswer"></rect>
        <text x="0" y="148" color="black" font-size="30">+</text>
        <rect height="100" width="400" x="20" y="160" class="divisionBox" id="rOpperandDivisonBox"></rect>
        <rect height="100" width="0" x="20" y="160" class="filledNum" id="rOpperandDivisonBoxFilled"></rect>
        <rect height="100" width="0" x="20" y="160" class="filledNum" id="rOpperandDivisonBoxAnswer"></rect>
        <line x1="15" x2="425" y1="280" y2="280" stroke="black" stroke-width="3px"></line>

        <foreignObject x="440" y="100" width="150" height="50" class="expandBtn" id="lOppExpandBtn"
            requiredExtensions="http://www.w3.org/1999/xhtml" style="display: none">
            <body xmlns="http://www.w3.org/1999/xhtml">
                <lable style="float: left">Expand</lable>
                <div class="btns" style="float: left; margin-left: 5px">
                    <button id="lOppExpandPlusBtn"><b>+</b></button>
                    <button id="lOppExpandMinusBtn"><b>-</b></button>
                </div>
            </body>
        </foreignObject>

        <foreignObject x="440" y="240" width="150" height="50" class="expandBtn" id="rOppExpandBtn"
            requiredExtensions="http://www.w3.org/1999/xhtml" style="display: none">
            <body xmlns="http://www.w3.org/1999/xhtml">
                <lable style="float: left">Expand</lable>
                <div class="btns" style="float: left; margin-left: 5px">
                    <button id="rOppExpandPlusBtn"><b>+</b></button>
                    <button id="rOppExpandMinusBtn"><b>-</b></button>
                </div>
            </body>
        </foreignObject>


    </svg>


</div>

<div style="clear: left; margin-left: 75px;">
    <button id="submitFraction" class="buttons" style="float: left">Start</button>
    <button id="resetBtn" class="buttons" style="float: left;">Reset</button>
    <button id="addBtn" class="buttons" style="display: none; float: left">Add</button>

</div>

<script>

    let leftOpperand = {
        box: d3.select('#lOpperandDivisonBox'),
        width: Number(d3.select('#lOpperandDivisonBox').attr('width')),
        height: Number(d3.select('#lOpperandDivisonBox').attr('height')),
        xLoc: Number(d3.select('#lOpperandDivisonBox').attr('x')),
        yLoc: Number(d3.select('#lOpperandDivisonBox').attr('y')),
        numerator: Number(0),
        denominator: Number(0),
        colour: '#8a2df3',
        multiplier: Number(1),
        answer: {
            box: d3.select('#lOpperandDivisonBoxAnswer'),
            width: 120,
            height: 100,
            xLoc: 20,
            yLoc: 300
        }
    };

    let rightOpperand = {
        box: d3.select('#rOpperandDivisonBox'),
        width: Number(d3.select('#rOpperandDivisonBox').attr('width')),
        height: Number(d3.select('#rOpperandDivisonBox').attr('height')),
        xLoc: Number(d3.select('#rOpperandDivisonBox').attr('x')),
        yLoc: Number(d3.select('#rOpperandDivisonBox').attr('y')),
        numerator: Number(0),
        denominator: Number(0),
        colour: '#f91750',
        multiplier: Number(1),
        answer: {
            box: d3.select('#rOpperandDivisonBoxAnswer'),
            width: 120,
            height: 100,
            xLoc: 20,
            yLoc: 300
        }
    };
    let divideBox = function (xVal, box, lineNum, isDashed) {
        let i = xVal;
        while(lineNum > 0){
            addLine(i + box.xLoc, i + box.xLoc, 0 + box.yLoc, box.height + box.yLoc, isDashed, box);
            i += xVal;
            lineNum --;
        }
    };

    let fillNumerator = function (xVal, box) {
        d3.select('#'+box.box.attr('id') + 'Filled')
            .transition().delay(function (d, i) {
            return i * 300;
        }).duration(500)
            .attr('width', xVal)
            .style('fill', box.colour)
            .each('end', function () {
                d3.select('#'+box.box.attr('id') + 'Answer')
                    .attr('width', xVal)
                    .style('fill', box.colour);
            });
    };

    let initBox = function (numerator, denominator, box) {
        let sectionLen = box.width / denominator;
        fillNumerator((numerator * sectionLen), box);
        divideBox(sectionLen, box, denominator - 1);
        drawFractionText(numerator, denominator, Number(box.width) + 60, Number(box.yLoc) + 30, 'originalFraction');
        d3.select('#addBtn').style('display', 'block');
    };

    let drawFractionText = function(numerator, denominator, xPos, yPos, secondaryClass) {
        d3.select('#mainCanvas').append('text')
            .attr('class', 'fractionText '+ secondaryClass)
            .text(numerator)
            .attr('x', function() {
                if(numerator < 10) {
                    return xPos + 7;
                }
                else {
                    return xPos;
                }
            })
            .attr('y', yPos);

        d3.select('#mainCanvas').append('text')
            .attr('class', 'fractionText '+ secondaryClass)
            .text(denominator)
            .attr('x', function() {
                if(denominator < 10) {
                    return xPos + 7;
                }
                else {
                    return xPos;
                }
            })
            .attr('y', yPos + 30);

        d3.select('#mainCanvas').append('line')
            .attr('class', 'textFractionLine ' + secondaryClass)
            .attr('x1', xPos)
            .attr('x2', xPos + 25)
            .attr('y1', yPos + 5)
            .attr('y2', yPos + 5)
            .style('stroke', 'black')
            .style('stroke-width', 2);
    }

    let addLine = function (x1, x2, y1, y2, isDashed, box) {
        let dashed = '0,0';
        let name = '';
        let stroke = 2;
        if(isDashed) {
            dashed = '4,3';
            name = box.box.attr('id') + 'DashedDivLine';
            stroke = 1
        }
        d3.select('#mainCanvas').append('line')
            .attr('class', 'divLine ' + name)
            .attr('x1', x1)
            .attr('x2', x2)
            .attr('y1', y1)
            .attr('y2', y2)
            .style('stroke', 'black')
            .style('stroke-width', stroke)
            .attr('stroke-dasharray', dashed);
    };

    let isValid = function (numerator, denominator) {
      if(numerator < 0 || numerator > 12 ) {
          return false;
      }
      if (denominator <= 0 || denominator > 12) {
          return false;
      }
      return (numerator < denominator);
    };

    let resetBoxes = function () {
        d3.selectAll('.filledNum').attr('width', 0);
        d3.select('#lOpperandDivisonBoxAnswer').attr('y', leftOpperand.yLoc);
        d3.select('#rOpperandDivisonBoxAnswer').attr('x', rightOpperand.xLoc).attr('y', rightOpperand.yLoc);
        d3.selectAll('.divLine').remove();
        d3.select('#answerBox').attr('width', 0).attr('height', 0);
        d3.selectAll('.textFractionLine').remove();
        d3.selectAll('.fractionText').remove();
        d3.selectAll('.expandBtn').style('display', 'none');
        d3.select('#addBtn').style('display', 'none');
        leftOpperand.multiplier = 1;
        rightOpperand.multiplier = 1;

    };

    let resetInputs = function () {
        document.getElementById('lOppNumerator').value = '';
        document.getElementById('lOppDenominator').value = '';
        document.getElementById('rOppNumerator').value = '';
        document.getElementById('rOppDenominator').value = '';
    };

    let addingAnimation = function () {
        updateAnswerValues(leftOpperand.answer);
        updateAnswerValues(rightOpperand.answer);
        rightXValue = Number(d3.select('#lOpperandDivisonBoxFilled').attr('width'));
        rightXValue += Number(d3.select('#lOpperandDivisonBoxFilled').attr('x'));
        leftDivLines = document.getElementById('lOppNumerator').value;
        rightDivLines = document.getElementById('rOppNumerator').value;
        boxWidth = 400;
        if(rightXValue + Number(d3.select('#rOpperandDivisonBoxFilled').attr('width')) - 20 > 400) {
            boxWidth = 800;
        }

        d3.selectAll('.expandBtn').style('display', 'block');

        d3.select('#answerBox')
            .transition().delay(function (d, i) {
            return i * 300;
        }).duration(800)
            .attr('width', boxWidth)
            .attr('height', 100);

        d3.select('#lOpperandDivisonBoxAnswer')
            .style('outline', 'solid black 2px')
            .transition().delay(function (d, i) {
            return i * 300;
        }).duration(1000)
            .attr('y', 300)
            .each('end', function () {
                d3.select('#rOpperandDivisonBoxAnswer')
                    .style('outline', 'solid black 2px')
                    .transition().delay(function (d, i) {
                    return i * 300;
                }).duration(1000)
                    .attr('y', 300)
                    .attr('x', rightXValue)
                    .each('end', function () {
                        let distance = d3.select('#lOpperandDivisonBoxAnswer').attr('width') / leftDivLines;
                        for(i = 0; i < leftDivLines; i++) {
                            addLine(20 + (distance * i), 20 + (distance * i), 300, 400);
                        }
                        distance = d3.select('#rOpperandDivisonBoxAnswer').attr('width') / rightDivLines;
                        for(i = 0; i < rightDivLines; i++) {
                            addLine(rightXValue + (distance * i), rightXValue + (distance * i), 300, 400);
                        }
                    })
            })

    }

    let updateAnswerValues = function(box) {
        let boxId = '#' + box.box.attr('id');
        box.width = Number(d3.select(boxId).attr('width'));
        box.height = Number(d3.select(boxId).attr('height'));
        box.xLoc = Number(d3.select(boxId).attr('x'));
        box.yLoc = Number(d3.select(boxId).attr('y'));
    }

    let addExpand = function(box, classText) {
        let name = box.box.attr('id') + classText;
        updateAnswerValues(box.answer);
        if(box.multiplier < 12) {
            d3.selectAll('.' + name).remove();
            d3.selectAll('.' + box.box.attr('id') + 'DashedDivLine').remove();
            d3.selectAll('.' + box.answer.box.attr('id') + 'DashedDivLine').remove();
            box.multiplier++
            drawExpand(box, name);
        }
    }

    let minusExpand = function(box, classText) {
        let name = box.box.attr('id') + classText;
        if(box.multiplier > 1) {
            d3.selectAll('.' + name).remove();
            d3.selectAll('.' + box.box.attr('id') + 'DashedDivLine').remove();
            d3.selectAll('.' + box.answer.box.attr('id') + 'DashedDivLine').remove();
            box.multiplier--;
            drawExpand(box, name);
        }
    }

    let drawExpand = function(box, classText) {
        drawFractionText(box.multiplier, box.multiplier, Number(box.width) + 110, Number(box.yLoc) + 30, classText);
        drawFractionText((Number(box.numerator) * Number(box.multiplier)), (Number(box.denominator) * Number(box.multiplier)), Number(box.width) + 170, Number(box.yLoc) + 30, classText);
        divideBox(box.width / (Number(box.multiplier) * Number(box.denominator)), box, Number(box.denominator) * Number(box.multiplier) - 1, true);
        divideBox(box.width / (Number(box.multiplier) * Number(box.denominator)), box.answer, Number(box.numerator) * Number(box.multiplier) - 1, true);
        d3.select('#mainCanvas').append('text')
            .attr('class', 'fractionText ' + classText)
            .text('X')
            .attr('x', Number(box.width) + 91)
            .attr('y', Number(box.yLoc) + 41)
            .style('font', '20px sans-serif');

        d3.select('#mainCanvas').append('text')
            .attr('class', 'fractionText ' + classText)
            .text('=')
            .attr('x', Number(box.width) + 146)
            .attr('y', Number(box.yLoc) + 41);
    }

    document.getElementById('submitFraction').onclick = function () {
        resetBoxes();
        leftOpperand.numerator = document.getElementById('lOppNumerator').value;
        leftOpperand.denominator = document.getElementById('lOppDenominator').value;
        rightOpperand.numerator = document.getElementById('rOppNumerator').value;
        rightOpperand.denominator = document.getElementById('rOppDenominator').value;
        if(isValid(Number(leftOpperand.numerator), Number(leftOpperand.denominator)) && isValid(Number(rightOpperand.numerator), Number(rightOpperand.denominator))) {
            initBox(Number(leftOpperand.numerator), Number(leftOpperand.denominator), leftOpperand);
            initBox(Number(rightOpperand.numerator), Number(rightOpperand.denominator), rightOpperand);
        } else {
            alert('Make sure your factions are proper and the denominators less then or equal to 12');
        }
    };

    document.getElementById('resetBtn').onclick = function () {
        resetBoxes();
        resetInputs();
    };

    document.getElementById('addBtn').onclick = function () {
        addingAnimation();
    };

    document.getElementById('lOppExpandPlusBtn').onclick = function() {
        addExpand(leftOpperand, 'FractionText');
    };

    document.getElementById('lOppExpandMinusBtn').onclick = function() {
        minusExpand(leftOpperand, 'FractionText');
    };

    document.getElementById('rOppExpandPlusBtn').onclick = function() {
        addExpand(rightOpperand, 'FractionText');
    };

    document.getElementById('rOppExpandMinusBtn').onclick = function() {
        minusExpand(rightOpperand, 'FractionText');
    };
</script>
</body>
</html>
